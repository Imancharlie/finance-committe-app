{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ member.name }} - Member Details{% endblock %}

{% block extra_css %}
<style>
    /* Compact styling consistent with dashboard */
    .compact-header h1 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #343a40;
    }

    .compact-header p {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .compact-header .btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }

    /* Compact table styling */
    .compact-table {
        font-size: 0.75rem;
    }

    .compact-table th,
    .compact-table td {
        padding: 0.4rem 0.3rem;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }

    .compact-table .amount-display {
        font-size: 0.7rem;
        white-space: nowrap;
    }

    .compact-table .member-name-link {
        font-size: 0.75rem;
        font-weight: 500;
        text-decoration: none;
    }

    .compact-table .member-name-link:hover {
        text-decoration: underline;
    }

    /* Table header styling */
    .compact-table thead th {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.5rem 0.3rem;
        background: var(--primary-color);
        color: white;
        border: none;
        text-align: center;
    }

    /* Compact card styling */
    .compact-card .card-header {
        padding: 0.75rem 1rem;
    }

    .compact-card .card-header h5 {
        font-size: 0.9rem;
        margin-bottom: 0;
    }

    .compact-card .card-body {
        padding: 1rem;
    }

    .compact-card .form-label {
        font-size: 0.75rem;
        margin-bottom: 0.3rem;
    }

    .compact-card .form-control {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }

    .compact-card .btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }

    /* Status badge styling */
    .status-badge {
        font-size: 0.6rem;
        padding: 0.15rem 0.4rem;
        white-space: nowrap;
        border-radius: 12px;
    }

    .status-complete { background-color: #d4edda; color: #155724; }
    .status-incomplete { background-color: #fff3cd; color: #856404; }
    .status-not-started { background-color: #f8d7da; color: #721c24; }
    .status-exceeded { background-color: #d1ecf1; color: #0c5460; }

    /* Transaction editing styles */
    .transaction-row {
        transition: background-color 0.3s ease;
    }

    .transaction-row.editing {
        background-color: #f8f9fa;
        border-left: 3px solid var(--primary-color);
    }

    .transaction-row.success-flash {
        background-color: #d4edda;
    }

    .edit-controls {
        white-space: nowrap;
    }

    .edit-controls .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        margin: 0 0.1rem;
    }

    .inline-edit-form {
        display: none;
    }

    .inline-edit-form.active {
        display: block;
    }

    .inline-edit-form input {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        margin: 0.1rem;
    }

    .inline-edit-form .form-control {
        min-width: 80px;
    }

    /* Modal styling */
    .modal-dialog {
        max-width: 500px;
    }

    .modal-header {
        background: var(--primary-color);
        color: white;
    }

    .modal-header .btn-close {
        filter: invert(1);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .compact-header h1 {
            font-size: 1.2rem;
        }

        .compact-header p {
            font-size: 0.75rem;
        }

        .compact-table {
            font-size: 0.7rem;
        }

        .compact-card .card-header h5 {
            font-size: 0.85rem;
        }

        .compact-card .form-label {
            font-size: 0.7rem;
        }

        .compact-card .form-control {
            font-size: 0.75rem;
        }

        .edit-controls .btn {
            padding: 0.1rem 0.3rem;
            font-size: 0.6rem;
        }
    }

    @media (max-width: 576px) {
        .compact-header h1 {
            font-size: 1.1rem;
        }

        .compact-header p {
            font-size: 0.7rem;
        }

        .compact-table {
            font-size: 0.65rem;
        }

        .compact-card .card-header h5 {
            font-size: 0.8rem;
        }

        .compact-card .form-label {
            font-size: 0.65rem;
        }

        .compact-card .form-control {
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Compact Header -->
<div class="d-flex justify-content-between align-items-center mb-3 compact-header">
    <div>
        <h1 class="mb-1">{{ member.name }}</h1>
        <p class="mb-0">Member Details & Transaction History</p>
    </div>
    <div class="btn-group">
        {% if can_edit_members %}
        <a href="{% url 'tracker:edit_member' member_id=member.id org_slug=tenant.slug %}" class="btn btn-outline-primary">
            <i class="bi bi-pencil me-1"></i>Edit
        </a>
        {% endif %}
        <a href="{% url 'tracker:dashboard' org_slug=tenant.slug %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<div class="row">
    <!-- Member Information -->
    <div class="col-md-4 mb-3">
        <div class="card compact-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-circle me-2"></i>Member Information
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted">Full Name</label>
                    <p class="mb-0 fw-bold">{{ member.name }}</p>
                </div>

                {% if member.phone %}
                <div class="mb-3">
                    <label class="form-label text-muted">Phone</label>
                    <p class="mb-0">
                        <a href="tel:{{ member.phone }}" style="text-decoration: none; color: inherit;">
                            <i class="bi bi-telephone me-2"></i>{{ member.phone }}
                        </a>
                    </p>
                </div>
                {% endif %}

                {% if member.email %}
                <div class="mb-3">
                    <label class="form-label text-muted">Email</label>
                    <p class="mb-0">
                        <i class="bi bi-envelope me-2"></i>{{ member.email }}
                    </p>
                </div>
                {% endif %}

                {% if member.course %}
                <div class="mb-3">
                    <label class="form-label text-muted">Course</label>
                    <p class="mb-0">{{ member.course }}</p>
                </div>
                {% endif %}

                {% if member.year %}
                <div class="mb-3">
                    <label class="form-label text-muted">Year</label>
                    <p class="mb-0">{{ member.year }}</p>
                </div>
                {% endif %}

                <div class="mb-3">
                    <label class="form-label text-muted">Member Since</label>
                    <p class="mb-0">{{ member.created_at|date:"M d, Y" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="col-md-8 mb-3">
        <div class="card compact-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cash-stack me-2"></i>Financial Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted mb-1" style="font-size: 0.75rem;">Total Pledge</h6>
                            <h4 class="amount-display">TZS {{ member.pledge|intcomma }}</h4>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted mb-1" style="font-size: 0.75rem;">Paid So Far</h6>
                            <h4 class="amount-display text-success">TZS {{ member.paid_total|intcomma }}</h4>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="text-center">
                            {% if member.has_exceeded %}
                            <h6 class="text-muted mb-1" style="font-size: 0.75rem;">Exceed By</h6>
                            <h4 class="amount-display text-success">TZS {{ member.remaining|abs_value|intcomma }}</h4>
                            {% else %}
                            <h6 class="text-muted mb-1" style="font-size: 0.75rem;">Remaining</h6>
                            <h4 class="amount-display text-warning">TZS {{ member.remaining|intcomma }}</h4>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar" style="width: {% widthratio member.paid_total member.pledge 100 %}%; max-width: 100%;"></div>
                </div>

                <div class="text-center">
                    <span class="status-badge
                        {% if member.has_exceeded %}status-exceeded{% elif member.is_complete %}status-complete{% elif member.is_incomplete %}status-incomplete{% else %}status-not-started{% endif %}">
                        {% if member.has_exceeded %}⬆ Exceeded Pledge
                        {% elif member.is_complete %}✓ Fully Paid
                        {% elif member.is_incomplete %}⚠ Partially Paid
                        {% else %}✗ Not Started{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="card compact-card mb-3">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-clock-history me-2"></i>Transaction History
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 compact-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Added By</th>
                        <th>Notes</th>
                        {% if can_edit %}<th>Actions</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr class="transaction-row" data-transaction-id="{{ transaction.id }}">
                        <td>
                            <span class="transaction-date">{{ transaction.date|date:"M d, Y" }}</span>
                        </td>
                        <td>
                            <span class="transaction-amount amount-display">TZS {{ transaction.amount|intcomma }}</span>
                        </td>
                        <td>{{ transaction.added_by.username }}</td>
                        <td>
                            <span class="transaction-note">
                                {{ transaction.note|default:"-" }}
                            </span>
                        </td>{% if can_edit %}
                        <td>
                            <div class="edit-controls">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-transaction-btn"
                                        data-transaction-id="{{ transaction.id }}"
                                        data-amount="{{ transaction.amount }}"
                                        data-note="{{ transaction.note|default:'' }}"
                                        title="Edit Transaction">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-transaction-btn"
                                        data-transaction-id="{{ transaction.id }}"
                                        title="Delete Transaction">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>{% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">No transactions yet</p>
                                <p class="small">Add a payment below to get started</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% if can_edit %}
<!-- Add New Payment -->
<div class="card compact-card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-plus-circle me-2"></i>Add New Payment
        </h5>
    </div>
    <div class="card-body">
        <form method="post" id="paymentForm">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ transaction_form.amount.id_for_label }}" class="form-label">
                        {{ transaction_form.amount.label }}
                        <span class="text-danger">*</span>
                    </label>
                    {{ transaction_form.amount }}
                    {% if transaction_form.amount.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in transaction_form.amount.errors %}
                                <i class="bi bi-exclamation-triangle me-1"></i>{{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">Enter amount in Tanzanian Shillings</small>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="{{ transaction_form.date.id_for_label }}" class="form-label">
                        {{ transaction_form.date.label }}
                        <span class="text-danger">*</span>
                    </label>
                    {{ transaction_form.date }}
                    {% if transaction_form.date.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in transaction_form.date.errors %}
                                <i class="bi bi-exclamation-triangle me-1"></i>{{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="col-md-4 mb-3">
                    <label for="{{ transaction_form.note.id_for_label }}" class="form-label">
                        {{ transaction_form.note.label }}
                    </label>
                    {{ transaction_form.note }}
                    {% if transaction_form.note.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in transaction_form.note.errors %}
                                <i class="bi bi-exclamation-triangle me-1"></i>{{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">Optional notes about this payment</small>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="bi bi-plus-circle me-2"></i>Record Payment
                </button>
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Payment will be recorded immediately and member totals will be updated
                </small>
            </div>
        </form>
    </div>
</div>
 {% endif %}
<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTransactionModalLabel">
                    <i class="bi bi-pencil me-2"></i>Edit Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">
                            Amount (TZS) <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="editAmount"
                               min="1" max="10000000" step="1000" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editNote" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNote" rows="3" maxlength="500"></textarea>
                        <div class="invalid-feedback"></div>
                        <small class="form-text text-muted">Optional notes about this payment</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTransactionBtn">
                    <i class="bi bi-check-circle me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages Display -->
{% if messages %}
<div class="mt-3">
    {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {% if message.tags == 'success' %}
                <i class="bi bi-check-circle me-2"></i>
            {% elif message.tags == 'error' %}
                <i class="bi bi-exclamation-triangle me-2"></i>
            {% elif message.tags == 'warning' %}
                <i class="bi bi-exclamation-triangle me-2"></i>
            {% else %}
                <i class="bi bi-info-circle me-2"></i>
            {% endif %}
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>// Complete the JavaScript section for member_detail.html template
$(document).ready(function() {
    let currentTransactionId = null;

    // Client-side form validation for new payments
    $('#paymentForm').on('submit', function(e) {
        const amount = $('#{{ transaction_form.amount.id_for_label }}').val();
        const date = $('#{{ transaction_form.date.id_for_label }}').val();

        // Clear previous error states
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').hide();

        let hasErrors = false;

        // Validate amount
        if (!amount || amount <= 0) {
            $('#{{ transaction_form.amount.id_for_label }}').addClass('is-invalid');
            hasErrors = true;
        }

        // Validate date
        if (!date) {
            $('#{{ transaction_form.date.id_for_label }}').addClass('is-invalid');
            hasErrors = true;
        }

        if (hasErrors) {
            e.preventDefault();
            return false;
        }

        // Show loading state
        $('#submitBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>Recording...');
    });

    // Real-time amount validation for new payments
    $('#{{ transaction_form.amount.id_for_label }}').on('input', function() {
        const amount = parseFloat($(this).val());
        const $field = $(this);

        if (amount <= 0) {
            $field.addClass('is-invalid');
            if (!$field.next('.invalid-feedback').length) {
                $field.after('<div class="invalid-feedback d-block"><i class="bi bi-exclamation-triangle me-1"></i>Amount must be greater than zero</div>');
            }
        } else if (amount > 10000000) {
            $field.addClass('is-invalid');
            if (!$field.next('.invalid-feedback').length) {
                $field.after('<div class="invalid-feedback d-block"><i class="bi bi-exclamation-triangle me-1"></i>Amount cannot exceed 10,000,000 TZS</div>');
            }
        } else {
            $field.removeClass('is-invalid');
            $field.next('.invalid-feedback').remove();
        }
    });

    // Edit transaction functionality
    $('.edit-transaction-btn').click(function() {
        currentTransactionId = $(this).data('transaction-id');
        const currentAmount = $(this).data('amount');
        const currentNote = $(this).data('note');

        // Populate modal fields
        $('#editAmount').val(currentAmount);
        $('#editNote').val(currentNote);

        // Clear any previous validation states
        $('#editTransactionForm .form-control').removeClass('is-invalid');
        $('#editTransactionForm .invalid-feedback').text('');

        // Show modal
        $('#editTransactionModal').modal('show');
    });

    // Save transaction changes
    $('#saveTransactionBtn').click(function() {
        const newAmount = $('#editAmount').val();
        const newNote = $('#editNote').val();

        // Validate inputs
        let hasErrors = false;

        if (!newAmount || newAmount <= 0) {
            $('#editAmount').addClass('is-invalid');
            $('#editAmount').next('.invalid-feedback').text('Amount must be greater than zero.');
            hasErrors = true;
        } else if (newAmount > 10000000) {
            $('#editAmount').addClass('is-invalid');
            $('#editAmount').next('.invalid-feedback').text('Amount cannot exceed 10,000,000 TZS.');
            hasErrors = true;
        } else {
            $('#editAmount').removeClass('is-invalid');
            $('#editAmount').next('.invalid-feedback').text('');
        }

        if (newNote.length > 500) {
            $('#editNote').addClass('is-invalid');
            $('#editNote').next('.invalid-feedback').text('Note cannot exceed 500 characters.');
            hasErrors = true;
        } else {
            $('#editNote').removeClass('is-invalid');
            $('#editNote').next('.invalid-feedback').text('');
        }

        if (hasErrors) {
            return;
        }

        // Show loading state
        $('#saveTransactionBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>Saving...');

        // Send AJAX request to update transaction
        $.ajax({
            url: '{% url "tracker:update_transaction_ajax" org_slug=tenant.slug %}',
            method: 'POST',
            data: JSON.stringify({
                transaction_id: currentTransactionId,
                amount: newAmount,
                note: newNote
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Update the transaction row in the table
                    const $row = $(`tr[data-transaction-id="${currentTransactionId}"]`);
                    $row.find('.transaction-amount').text(response.formatted_amount);
                    $row.find('.transaction-note').text(response.new_note || '-');

                    // Update button data attributes
                    $row.find('.edit-transaction-btn').data('amount', response.new_amount);
                    $row.find('.edit-transaction-btn').data('note', response.new_note);

                    // Flash success animation
                    $row.addClass('success-flash');
                    setTimeout(() => $row.removeClass('success-flash'), 2000);

                    // Close modal and show success message
                    $('#editTransactionModal').modal('hide');
                    showAlert('Transaction updated successfully!', 'success');

                    // Refresh page to update totals
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showAlert(response.error || 'Error updating transaction', 'danger');
                }
            },
            error: function() {
                showAlert('Network error. Please try again.', 'danger');
            },
            complete: function() {
                $('#saveTransactionBtn').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Save Changes');
            }
        });
    });

    // Delete transaction functionality
    $('.delete-transaction-btn').click(function() {
        const transactionId = $(this).data('transaction-id');
        const $row = $(this).closest('tr');

        if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
            // Show loading state
            $(this).prop('disabled', true).html('<i class="bi bi-hourglass-split"></i>');

            // Send AJAX request to delete transaction
            $.ajax({
                url: '{% url "tracker:delete_transaction_ajax" org_slug=tenant.slug %}',
                method: 'POST',
                data: JSON.stringify({
                    transaction_id: transactionId
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Remove the row with animation
                        $row.fadeOut(300, function() {
                            $(this).remove();

                            // Check if table is empty
                            if ($('.transaction-row').length === 0) {
                                $('tbody').html(`
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                                                <p class="mt-2 mb-0">No transactions yet</p>
                                                <p class="small">Add a payment below to get started</p>
                                            </div>
                                        </td>
                                    </tr>
                                `);
                            }
                        });

                        showAlert('Transaction deleted successfully!', 'success');

                        // Refresh page to update totals
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showAlert(response.error || 'Error deleting transaction', 'danger');
                    }
                },
                error: function() {
                    showAlert('Network error. Please try again.', 'danger');
                },
                complete: function() {
                    $('.delete-transaction-btn').prop('disabled', false).html('<i class="bi bi-trash"></i>');
                }
            });
        }
    });

    // Real-time validation for edit modal
    $('#editAmount').on('input', function() {
        const amount = parseFloat($(this).val());
        const $field = $(this);

        if (amount <= 0) {
            $field.addClass('is-invalid');
            $field.next('.invalid-feedback').text('Amount must be greater than zero.');
        } else if (amount > 10000000) {
            $field.addClass('is-invalid');
            $field.next('.invalid-feedback').text('Amount cannot exceed 10,000,000 TZS.');
        } else {
            $field.removeClass('is-invalid');
            $field.next('.invalid-feedback').text('');
        }
    });

    $('#editNote').on('input', function() {
        const note = $(this).val();
        const $field = $(this);

        if (note.length > 500) {
            $field.addClass('is-invalid');
            $field.next('.invalid-feedback').text('Note cannot exceed 500 characters.');
        } else {
            $field.removeClass('is-invalid');
            $field.next('.invalid-feedback').text('');
        }
    });

    // Utility function to show alerts
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        // Remove existing alerts
        $('.alert').remove();

        // Add new alert at the top of the page
        $('body').prepend(alertHtml);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // Auto-dismiss existing messages after 5 seconds
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
});</script>
{% endblock extra_js %}
